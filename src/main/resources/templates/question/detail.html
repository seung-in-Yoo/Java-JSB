<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title th:text="${question.title}">질문 상세</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root{
            --bg:#fafafa; --card:#fff; --text:#111; --muted:#6b7280; --line:#e5e7eb;
            --brand:#413D3D; --brand-weak:#ebe9e9; --shadow:0 8px 24px rgba(0,0,0,.06);
            --radius:14px;
        }
        @media (prefers-color-scheme: dark){
            :root{ --bg:#0b0c0f; --card:#13151a; --text:#e8e9ee; --muted:#9aa0ab; --line:#2a2e37; --brand-weak:#2a2323; --shadow:0 8px 30px rgba(0,0,0,.45); }
            a{ color:inherit }
        }

        *{box-sizing:border-box}
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
            margin:0;background:var(--bg);color:var(--text);line-height:1.55}
        a{color:inherit;text-decoration:none}
        a:hover{text-decoration:underline}
        a:visited{color:inherit}

        .container{max-width:880px;margin:auto;padding:24px 18px}
        .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
            box-shadow:var(--shadow)}

        /* Top nav back */
        .back-link{
            display:inline-flex;align-items:center;gap:10px;
            padding:10px 14px;border:1px solid var(--line);border-radius:12px;
            background:var(--card);font-weight:600;box-shadow:var(--shadow)
        }
        .back-link svg{width:18px;height:18px}
        .back-link:hover{text-decoration:none;transform:translateY(-1px)}

        /* Header */
        h1{margin:16px 0 10px;font-size:28px;letter-spacing:-.3px}
        .meta{font-size:13px;color:var(--muted);display:flex;gap:12px;flex-wrap:wrap}
        .meta > span+span{position:relative;padding-left:12px}
        .meta > span+span::before{content:"·";position:absolute;left:2px;top:0;color:var(--muted)}
        .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
            background:var(--brand-weak);color:var(--text);border:1px solid var(--line);font-weight:600}

        .section{margin-top:20px}
        .content{margin-top:16px;font-size:16px}
        .content p{margin:0 0 14px}
        .divider{height:1px;background:var(--line);margin:22px 0}

        /* 공통 버튼 스타일 */
        .btn, .comment-btn, .comments form button, .editor button, #editModal button, .comment-actions button {
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            padding:8px 14px;
            font-size:14px;
            border-radius:10px;
            border:1px solid var(--line);
            background:var(--card);
            color:var(--text);
            cursor:pointer;
            transition:all 0.2s;
            text-decoration:none;
        }

        /* Primary 버튼 */
        .btn.primary, .editor button.primary, #editModal button.primary {
            background:var(--brand);
            color:#fff;
            border-color:var(--brand);
        }

        /* Danger 버튼 */
        .btn.danger {
            background:#c0392b;
            color:#fff;
            border-color:#c0392b;
        }

        /* Hover 효과 */
        .btn:hover, .comment-btn:hover, .comments form button:hover, .editor button:hover, #editModal button:hover {
            transform:translateY(-1px);
            background:var(--brand-weak);
            color:var(--brand);
        }





        /* Answers */
        .ans{padding:18px;border:1px solid var(--line);border-radius:12px;background:var(--card);margin-top:12px}
        .ans .meta{margin-bottom:8px}
        .editor textarea{width:100%;border:1px solid var(--line);border-radius:12px;padding:12px;
            background:var(--card);color:var(--text)}

        /* Comments */
        .comments{margin-top:12px; padding-left:0;}
        .comment{
            padding:12px 16px;
            border:1px solid var(--line);
            border-radius:12px;
            background:var(--card);
            margin-top:10px;
        }
        .comment .meta{
            font-size:12px;
            color:var(--muted);
            display:flex;
            gap:8px;
            margin-bottom:6px;
            flex-wrap:wrap;
        }
        .comment .content{
            font-size:14px;
            margin:0;
        }

        /* 댓글 작성 폼 */
        .comments form{
            margin-top:10px;
        }
        .comments form textarea{
            width:100%;
            border:1px solid var(--line);
            border-radius:12px;
            padding:12px;
            background:var(--card);
            color:var(--text);
            resize:none;
        }

        .comment-actions {
            display: flex;
            gap: 8px;
            margin-top: 6px;
            justify-content: flex-end;
        }

        .comment-actions form {
            margin: 0;
        }

        .comment-actions button {
            margin: 0;
        }

    </style>
</head>
<body>
<div class="container">

    <a th:href="@{/questions}" class="back-link" aria-label="목록으로 돌아가기">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M15 18l-6-6 6-6"/>
        </svg>
        <span>목록</span>
    </a>

    <article class="section card" style="padding:22px;">
        <h1 th:text="${question.title}">제목</h1>
        <div class="meta">
            <span class="chip" th:text="${question.categoryName}">카테고리</span>
            <span th:text="${question.author.name}">작성자</span>
            <span th:text="${#temporals.format(question.createdAt,'yyyy.MM.dd HH:mm')}">작성일</span>
            <span th:text="|조회 ${question.viewCount}|">조회 0</span>
        </div>

        <div class="content" th:utext="${question.contentHtml}">본문</div>

        <div class="divider"></div>

        <div th:if="${isQuestionAuthor}" style="display:flex; gap:8px;">
            <a class="btn" th:href="@{|/questions/${question.id}/edit|}">수정</a>
            <form th:action="@{|/questions/${question.id}|}" method="post"
                  onsubmit="return confirm('정말 삭제하시겠어요? 삭제 후에는 되돌릴 수 없습니다.');">
                <input type="hidden" name="_method" value="delete" />
                <button class="btn danger" type="submit">삭제</button>
            </form>
        </div>
    </article>

    <!-- 답변 + 댓글 -->
    <section class="section">
        <h2 th:text="|답변 ${#lists.size(answers)}|">답변 0</h2>

        <div th:each="a : ${answers}" class="ans">
            <div class="meta">
                <span th:text="${a.author.nickname}">작성자</span>
                <span th:text="${#temporals.format(a.createdAt,'yyyy.MM.dd HH:mm')}">날짜</span>
            </div>
            <a th:href="@{|/questions/update/${a.id}|}" style="text-decoration: none; color: inherit;">
                <div class="content" th:utext="${a.contentHtml}">답변 내용</div>
            </a>

            <!-- 댓글 목록 -->
            <div class="comments">
                <h4 th:text="|댓글 ${a.comments != null ? #lists.size(a.comments) : 0}|">댓글 0</h4>

                <div th:each="c : ${a.comments}" class="comment">
                    <div class="meta">
                        <span th:text="${c.author.nickname}">댓글 작성자</span>
                        <span th:text="${#temporals.format(c.createdAt,'yyyy.MM.dd HH:mm')}">날짜</span>
                    </div>
                    <div class="content" th:text="${c.content}">댓글 내용</div>

                    <div class="comment-actions" th:if="${isLoggedIn and c.author.username == #authentication.name}"
                         th:attr="data-id=${c.id}, data-content=${c.content}">
                        <button type="button" class="btn" onclick="openEditModalFromButton(this)">수정</button>
                        <form th:action="@{|/comments/${c.id}/delete|}" method="post"
                              onsubmit="return confirm('정말 삭제하시겠어요? 삭제 후에는 되돌릴 수 없습니다.');">
                            <button type="submit" class="btn">삭제</button>
                        </form>

                    </div>
                </div>

                <!-- 댓글 작성 폼 -->
                <div th:if="${isLoggedIn}" style="margin-top:10px;">
                    <form th:action="@{|/answers/${a.id}/comments|}" method="post">
                        <textarea name="content" rows="3" placeholder="댓글을 입력하세요"></textarea>
                        <button class="btn primary" type="submit">댓글 등록</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- 답변 작성 -->
    <section class="section card editor" th:if="${isLoggedIn}" style="padding:18px;">
        <h3>답변 작성</h3>
        <form th:action="@{|/questions/${question.id}/answers|}" method="post">
            <textarea name="content" rows="8" placeholder="답변 내용을 입력하세요"></textarea>
            <div style="margin-top:12px;display:flex;gap:8px;">
                <button class="btn primary" type="submit">등록</button>
            </div>
        </form>
    </section>

    <!-- 로그인 안내 -->
    <section class="section" th:if="${!isLoggedIn}">
        <a class="btn" th:href="@{/login}">로그인 후 답변을 작성할 수 있어요</a>
    </section>

</div>

<!-- 댓글 수정 모달 -->
<div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
     background:rgba(0,0,0,0.17); justify-content:center; align-items:center;">
    <div style="background:rgba(255,255,255,0); padding:20px; border-radius:8px; width:400px; position:relative;">
        <h3>댓글 수정</h3>
        <form id="editForm" method="post">
            <textarea id="editContent" name="content" rows="4" style="width:100%;"></textarea>
            <div style="margin-top:10px; text-align:right; display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" class="btn" onclick="closeEditModal()">취소</button>
                <button type="submit" class="btn primary">저장</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openEditModalFromButton(button) {
        const commentId = button.parentElement.dataset.id;
        const commentContent = button.parentElement.dataset.content;

        document.getElementById("editModal").style.display = "flex";
        document.getElementById("editContent").value = commentContent;
        document.getElementById("editForm").action = "/comments/" + commentId + "/edit";
    }

    function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
    }
</script>
</body>
</html>
